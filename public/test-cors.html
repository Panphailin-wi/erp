<!DOCTYPE html>
<html>
<head>
    <title>Test CORS Connection</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .result { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Test Backend Connection</h1>

    <button onclick="testSimpleGet()">1. Test Simple GET (no CORS)</button>
    <button onclick="testCORSGet()">2. Test GET with CORS</button>
    <button onclick="testPOST()">3. Test POST Payment Voucher</button>
    <button onclick="testOPTIONS()">4. Test OPTIONS (Preflight)</button>

    <div id="results"></div>

    <script>
        const resultsDiv = document.getElementById('results');
        const API_URL = 'http://127.0.0.1:8000';

        function addResult(title, content, isError = false) {
            const div = document.createElement('div');
            div.className = 'result ' + (isError ? 'error' : 'success');
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            resultsDiv.insertBefore(div, resultsDiv.firstChild);
        }

        async function testSimpleGet() {
            try {
                const response = await fetch(`${API_URL}/api/users`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });

                console.log('Simple GET Response:', response);
                const data = await response.json();
                addResult('✅ Simple GET', `Status: ${response.status}\nData: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                console.error('Simple GET Error:', error);
                addResult('❌ Simple GET Failed', error.message, true);
            }
        }

        async function testCORSGet() {
            try {
                const response = await fetch(`${API_URL}/api/users`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Origin': window.location.origin
                    },
                    mode: 'cors'
                });

                console.log('CORS GET Response:', response);
                console.log('CORS Headers:', [...response.headers.entries()]);
                const data = await response.json();
                addResult('✅ CORS GET', `Status: ${response.status}\nData: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                console.error('CORS GET Error:', error);
                addResult('❌ CORS GET Failed', error.message, true);
            }
        }

        async function testPOST() {
            try {
                const items = [
                    {
                        id: '1',
                        productId: 1,
                        description: 'ค่าบริการ',
                        amount: 1000
                    }
                ];

                const testData = {
                    voucher_no: 'PV' + Date.now().toString().slice(-6),
                    date: '2025-10-28',
                    payee: 'กรมพัฒนาธุรกิจการค้า',
                    payee_id: 1,
                    payment_method: 'โอนเงิน',
                    payment_date: '2025-10-28',
                    tax_type: 'excluding',
                    salesperson: 'ทดสอบ',
                    withholding_tax_no: 'WT001',
                    withholding_tax_amount: 100,
                    items: JSON.stringify(items), // แปลงเป็น JSON string
                    notes: 'ทดสอบ',
                    discount: 0,
                    vat_rate: 7,
                    subtotal: 1000,
                    discount_amount: 0,
                    after_discount: 1000,
                    vat: 70,
                    grand_total: 1170,
                    amount: 1170,
                    status: 'รอจ่าย'
                };

                console.log('Sending POST data:', testData);

                const response = await fetch(`${API_URL}/api/payment-vouchers`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });

                console.log('POST Response:', response);
                console.log('Response Headers:', [...response.headers.entries()]);

                const result = await response.json();
                if (response.ok) {
                    addResult('✅ POST Payment Voucher',
                        `Status: ${response.status}\nResult: ${JSON.stringify(result, null, 2)}`);
                } else {
                    addResult('❌ POST Failed',
                        `Status: ${response.status}\nError: ${JSON.stringify(result, null, 2)}`,
                        true);
                }
            } catch (error) {
                console.error('POST Error:', error);
                addResult('❌ POST Failed',
                    `Error: ${error.message}\n\nThis means the request never reached the backend.\nCheck console for more details.`,
                    true);
            }
        }

        async function testOPTIONS() {
            try {
                const response = await fetch(`${API_URL}/api/payment-vouchers`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });

                console.log('OPTIONS Response:', response);
                console.log('CORS Headers:', [...response.headers.entries()]);

                const headers = {};
                response.headers.forEach((value, key) => {
                    if (key.toLowerCase().startsWith('access-control')) {
                        headers[key] = value;
                    }
                });

                addResult('✅ OPTIONS (Preflight)',
                    `Status: ${response.status}\nCORS Headers:\n${JSON.stringify(headers, null, 2)}`);
            } catch (error) {
                console.error('OPTIONS Error:', error);
                addResult('❌ OPTIONS Failed', error.message, true);
            }
        }

        // Run first test automatically
        window.onload = () => {
            addResult('ℹ️ Info', `Testing from: ${window.location.origin}\nBackend: ${API_URL}`);
        };
    </script>
</body>
</html>
